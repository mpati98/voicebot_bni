<!DOCTYPE html>
<html lang="en">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <link
    rel="stylesheet"
    href="https://use.fontawesome.com/releases/v5.12.1/css/all.css"
    crossorigin="anonymous"
  />
  <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css"
  />
  <head>
    <meta charset="UTF-8" />
    <title>Chatbot</title>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <script>
      $(document).ready(function () {
        $(".owl-carousel").owlCarousel({
          items: 1,
          loop: true,
          nav: true,
          dots: true,
          autoplay: true,
          autoplaySpeed: 500,
          smartSpeed: 1500,
          autoplayHoverPause: true,
        });
      });
    </script>
    <div class="container">
      <div class="chatbox">
        <div class="chatbox__support">
          <div class="chatbox__header">
            <div class="chatbox__image--header">
              <img
                src="https://img.icons8.com/color/48/000000/circled-user-female-skin-type-5--v1.png"
                alt="image"
              />
            </div>
            <div class="chatbox__content--header">
              <h4 class="chatbox__heading--header">Chat support</h4>
              <p class="chatbox__description--header">
                Xin chào! Tôi có thể giúp gì cho bạn?
              </p>
            </div>
          </div>
          <div class="chatbox__messages">
            <div></div>
          </div>
          <div class="chatbox__footer">
            <button class="chatbox__send--footer voice__button">
              <i class="fa fa-microphone"></i>
            </button>
            <input type="text" placeholder="Write a message..." />
            <button class="chatbox__send--footer send__button">Send</button>
          </div>
        </div>
        <div class="chatbox__button">
          <button>
            <img
              src="{{ url_for('static', filename='images/chatbox-icon.svg') }}"
            />
          </button>
        </div>
      </div>
      <div class="owl-carousel owl-theme">
        <div class="slide slide-1">
          <div class="slide-content">
            <h1>BNI RIVERSIDE: KHỞI CÔNG NÂNG CẤP VÀ SỬA CHỮA TRƯỜNG MẦM NON TÂN NHƠN</h1>
            <p>
              Khởi công nâng cấp và sửa chữa trường mầm non Tân Nhơn tại xã Tân Thới, huyện Phong Điền, Cần Thơ đã diễn ra thành công vào ngày 3/7/2023. Buổi lễ này đã thu hút sự tham gia của nhiều đại biểu quan trọng, đặc biệt là đại diện từ BNI Riverside – nhà tài trợ chính cho dự án. Với tên công trình “Nâng cấp sửa chữa trường mầm non Tân Nhơn” dự án này đã nhận đầu tư 350.000.000 đồng từ BNI Riverside, một Chapter tại tỉnh Cần Thơ thuộc cộng đồng BNI. Đại diện của BNI Riverside đã tham gia buổi lễ khởi công, gửi lời chúc mừng và cam kết hỗ trợ tận tâm để đảm bảo dự án thành công và mang lại những điều tốt đẹp cho cộng đồng.
            </p>
          </div>
        </div>
        <div class="slide slide-2">
          <div class="slide-content">
            <h1>BNI HQH: GẮN KẾT SỨC MẠNH – HỘI TỤ THÀNH CÔNG</h1>
            <p>
              Trong hai ngày 1 và 2/7, cộng đồng doanh nghiệp BNI HQH (Hải Phòng – Quảng Ninh – Hải Dương) đã tổ chức chương trình thể thao và kết nối kinh doanh với chủ đề Gắn kết sức mạnh – Hội tụ thành công tại TP Hạ Long.
            </p>
          </div>
        </div>
        <div class="slide slide-3">
          <div class="slide-content">
            <h1>NGÀY HỘI SPORTS DAY 2023: GẮN KẾT CÁC THÀNH VIÊN VÙNG BNI HQH THÔNG QUA HOẠT ĐỘNG THỂ THAO, BUSINESS MATCHING VÀ ĐÀO TẠO</h1>
            <p>
              Ngày hội Sports Day 2023 là chuỗi sự kiện thường niên, ngày 01,02/07/2023 vừa qua được tổ chức tại Hạ Long nhằm tăng cường sự gắn kết và tạo dựng mối quan hệ chặt chẽ giữa các Thành viên của Vùng BNI HQH (Hải Phòng, Quảng Ninh, Hải Dương).
            </p>
          </div>
        </div>
      </div>
    </div>
    <script>
      class Chatbox {
        constructor() {
          this.args = {
            openButton: document.querySelector(".chatbox__button"),
            chatBox: document.querySelector(".chatbox__support"),
            sendButton: document.querySelector(".send__button"),
            voiceButton: document.querySelector(".voice__button"),
          };

          this.state = false;
          this.message = [];
        }
        display() {
          const { openButton, chatBox, sendButton, voiceButton } = this.args;

          openButton.addEventListener("click", () => this.toggleState(chatBox));

          sendButton.addEventListener("click", () =>
            this.onSendButton(chatBox)
          );
          voiceButton.addEventListener("click", () =>
            this.onVoiceButton(chatBox)
          );

          const node = chatBox.querySelector("input");
          node.addEventListener("keyup", ({ key }) => {
            if (key === "Enter") {
              this.onSendButton(chatBox);
            }
          });
        }
        toggleState(chatbox) {
          this.state = !this.state;
          if (this.state) {
            chatbox.classList.add("chatbox--active");
            // fetch("http://127.0.0.1:5000/welcome", {
              fetch("https://chatbot-bni-leqdt7akva-as.a.run.app/welcome", {
              method: "POST",
              body: JSON.stringify(),
              mode: "cors",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((r) => r.json())
              .then((r) => {
                // console.log(r.audio);
                let msg = { name: "Sam", message: r.res_text };
                let audio_tag = r.res_audio;
                let audio = new Audio(
                  "https://firebasestorage.googleapis.com/v0/b/arti-web-daae5.appspot.com/o/" +
                    audio_tag +
                    ".mp3?alt=media&token=5b140a75-f7f1-4468-a138-29ef98f6ef97"
                );
                audio.play();
                this.message.push(msg);
                this.updateChatText(chatbox);
              })
              .catch((error) => {
                console.log("Error: ", error);
                this.updateChatText(chatbox);
              });
          } else {
            chatbox.classList.remove("chatbox--active");
          }
        }

        onSendButton(chatbox) {
          var textField = chatbox.querySelector("input");
          let text1 = textField.value;
          if (text1 === "") {
            return;
          }
          let msg1 = { name: "User", message: text1 };
          this.message.push(msg1);
          // fetch("http://127.0.0.1:5000/response", {
            fetch("https://chatbot-bni-leqdt7akva-as.a.run.app/response", {
            method: "POST",
            body: JSON.stringify({ message: text1 }),
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((r) => r.json())
            .then((r) => {
              let msg2 = { name: "Sam", message: r.res_text };
              this.message.push(msg2);
              this.updateChatText(chatbox);
              textField.value = "";
            })
            .catch((error) => {
              console.error("Error: ", error);
              this.updateChatText(chatbox);
              textField.value = "";
            });
        }
        onVoiceButton(chatbox) {
          // var SpeechRecognition = webkitSpeechRecognition;
          let recognition = new webkitSpeechRecognition();
          recognition.lang = "vi-VN";
          recognition.interimResults = true;
          recognition.continuous = true;
          var content = "";
          var chatmessage = chatbox.querySelector(".chatbox__messages");
          // var E_state = '';
          if (!this.recordS) {
            recognition.start();
            console.log("starting");
            recognition.onerror = function (event) {
              // message.textContent = 'Error occurred in recognition: ' + event.error;
              console.log(event.error);
              chatmessage.textField = "nothing";
            };

            recognition.onresult = function (event) {
              var lastResult = event.results.length - 1;
              content = event.results[lastResult][0].transcript;
              chatmessage.textField = content;

            };
            recognition.onspeechend = function () {
              recognition.stop();
            };
            this.recordS = true;
          } else {
            content = chatmessage.textField;
            console.log(content)
            try{
              if (content == "nothing"){
                var msg1 = { name: "User", message: 'không nghe rõ'};
              }
              else if (typeof content == "undefined") {
                var msg1 = { name: "User", message: 'không nghe rõ'};
              }
              else{
                var msg1 = {name: "User", message: content}
              }
            }
            catch(err){
              console.log(err)
              var msg1 = { name: "User", message: ''};
            }
            this.message.push(msg1);
            this.updateChatText(chatbox);
            // fetch("http://127.0.0.1:5000/response", {
              fetch("https://chatbot-bni-leqdt7akva-as.a.run.app/response", {
              method: "POST",
              body: JSON.stringify({ message: content }),
              mode: "cors",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((r) => r.json())
              .then((r) => {
                // let msg2 = {name: "User", message: r.question}
                // this.messages.push(msg2)
                let msg3 = { name: "Sam", message: r.res_text };
                var audio_tag = r.res_audio;
                var audio_token = r.audio_token;
                let audio = new Audio(
                  "https://firebasestorage.googleapis.com/v0/b/arti-web-daae5.appspot.com/o/" +
                    audio_tag +
                    ".mp3?alt=media&token=" +
                    audio_token
                );
                audio.play();
                this.message.push(msg3);
                this.updateChatText(chatbox);
              })
              .catch((error) => {
                // console.error('Error: ', error);
                this.updateChatText(chatbox);
              });
            this.recordS = false;
          }
        }
        updateChatText(chatbox) {
          var html = "";
          this.message
            .slice()
            .reverse()
            .forEach(function (item) {
              if (item.name === "Sam") {
                html +=
                  '<div class="messages__item messages__item--visitor">' +
                  item.message +
                  "</div>";
              } else {
                html +=
                  '<div class="messages__item messages__item--operator">' +
                  item.message +
                  "</div>";
              }
            });
          const chatmessage = chatbox.querySelector(".chatbox__messages");
          chatmessage.innerHTML = html;
        }
      }

      const chatbox = new Chatbox();
      chatbox.display();
    </script>
  </body>
</html>
